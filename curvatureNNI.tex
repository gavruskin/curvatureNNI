\documentclass{amsart}

\synctex=1

\usepackage{amsmath,amsthm}
\usepackage{todonotes}
\usepackage[notref,notcite]{showkeys} % show keys for eqs, etc.
%\usepackage{cite}
\usepackage{enumerate}
\usepackage{url}
\usepackage[colorlinks=true]{hyperref}
\usepackage{natbib}

\newtheorem{lemma}{Lemma}
\newtheorem{question}{Question}
\newtheorem{proposition}{Proposition}

\newcommand{\tN}{\mathrm{\tau NNI}}
\newcommand{\dts}{\mathrm{DTS}}

\begin{document}

\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this paper we study the curvature of Markov chains over phylogenetic trees. 
We see different spaces of phylogenetic trees as graphs where the adjacency 
relation is given by a tree move. Those graphs can be also seen as metric 
spaces where the distance between two points is given by the length of a
shortest path connecting them. All graphs we are considering in this paper are
connected, so thus defined distance is a metric indeed. 

A Markov chain (often a random walk in our case) is defined on a graph by its
proposal mechanism, which is a functional $m$ that maps vertices of the graph to
the set of measures on this graph. In other words, for every vertex $v$, 
$m_v(w)$ is the (probability) of getting from $v$ to $w$ in one step. 

We consider a number of Markov chains that arise 
\todo{Do they?} 
in phylogenetic Bayesian 
inference and investigate the curvature of those chains with an eye towards 
the efficiency properties of the corresponding inference methods. 

\section{Discrete time-tree space}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this section we introduce a discrete analogue of the space of time-trees
and establish several graph-theoretic properties of this space, which will
be useful in later section for the study of the curvature of certain random
walks on the space. 

The easiest way to define the space is to assume that the reader is familiar 
with~\cite{Gavryushkin2014-bw} and say that the 
{\em discrete time-tree space,}
or $\dts$ for short, is the $\mathrm t$-space defined 
in~\cite{Gavryushkin2014-bw}, where the
branch lengths are allowed to take only three values, $0$, $1$, and $2$. 
In other words, to define a tree in the $\dts$, we first fix a ranked tree 
topology with all nodes being of different ranks and then assign a number
from $\{1,2\}$ to every intercoalescent interval. Intuitively, we will have
only two options for the length of an intercoalescent interval, which can
be thought of as short 
\todo{I'm fairly certain that all we are going to say about this space can
be generalised to $n$ intercoalescent interval lengths.}
and long. 
We shall address to the numbers assigned to the coalescent intervals as to
the {\em lengths} of those intervals. 

Two trees from $\dts$ are adjacent if and only if precisely one of the following
conditions is satisfied: 

\begin{enumerate}[(1)]
\item The trees have identical ranked topologies and there exists a unique
intercoalescent interval such that its length in one tree is smaller than in the
other by one unit. 
\item The trees have identical topologies, there exists a unique pair of nodes
which have different rank in the two trees, and the intercoalescent intervals 
between these two nodes are of the smallest possible length in both trees. 
\item The trees have topologies which differ by one NNI move, all nodes that
are not involved in the NNI move have identical ranks, all intercoalescent
intervals that are not involved in the NNI move have identical lengths, 
and the two intervals that are involved in the NNI move (the one that was there
before the move and the one that appeared after the move) both have the minimal
possible length.  
\end{enumerate}

In other words, by going from one tree to an adjacent tree in the graph we can
either change the length of one intercoalescent interval by one unit or we
can send an intercoalescent interval of minimal length down to zero and
then resolve the multifurcation to either of the two possible topologies
(one possible topology if there is no multifurcation) and
assign the minimal length to the new interval.

Thus, we will interchangeable refer to $\dts$ as a graph or a metric space. 
We will denote the corresponding distance by $d_\dts$. 
\todo{ 
What are the other tree spaces to which the results below apply?
	}

We denote the number of taxa by $n$ throughout the paper and assume $n \geq 3$.

\begin{lemma}
Let $T$ be a $\dts$-tree on $n$ leaves. Then \[2(n-1)\leq \deg(T)\leq3(n-1)\] 
\end{lemma}

\proof
The lower bounded is attained by any tree with all intercoalescent intervals 
long, or by a tree which as has no intercoalescent interval between a parent and
a child, apart from the root, and the root interval is long. It is simply the
number of intercoalescent events, since every intercoalescent interval adds $1$
to the total degree of the tree. The upper bound is attained by a 
caterpillar-tree with all intervals short and no coalescent event being younger
that a taxon. It is $n-1$, the number of intervals between the taxa, plus 
$2(n-1)$, twice the number of intervals between coalescent events, because 
every such an intervals results in two neighbours in the $\dts$ graph from
the corresponding NNI move. 
\endproof

Note that the lower bound would be $2n-1$ if we would drop the interval lengths
and look at ranked tree topologies only, the upper bound would remain the same.
Note also that no other tree attains the upper bound. 

\begin{lemma} The following are satisfied. 
\begin{enumerate}[(1)]
\item $deg(T)-deg(R) \leq n-1.$
\item $\dfrac{\deg(T)}{deg(R)} \leq \dfrac23$ and the equality is attained for
all $n$. 
\end{enumerate}
\end{lemma}

\proof
Follows from previous Lemma. 
\endproof

Let $N(T)$ be the set of trees at distance one from $T$, that is, the set of
trees adjacent to $T$ in the $\dts$ graph. 

\begin{lemma}\label{intersecNeighb}
If $d_{\dts}(T,R) = 1$ then $|N(T)\cap N(R)|\in\{0,1\}$.
\end{lemma}

\proof
Suppose $T$ and $R$ are $\dts$-neighbours. Unless the trees are NNI-neighbours,
they do not have a neighbour in
common. If $T$ and $R$ are NNI-neighbours, there is precisely one tree which is
a neighbour of both $T$ and $R$, namely the third tree that can be obtained by
resolving the interval that connects $T$ and $R$. 
\endproof

The following general lemma is true for all graphs, particularly, for $\dts$. 
By {\em distance-one random walk}, we mean a random walk $(m_x)_{x \in X}$ 
satisfying $m_x(y) = 0$ for all $x$ and $y$ such that $d(x,y) > 1$. 

\begin{lemma}\label{curvBoundGeneral}
Let $(M,d)$ be a finite metric space and $x,y$ a pair of points from $M$. If
$(m_x)_{x \in M}$ is a distance-one random walk on $M$, then the curvature 
$\kappa$ of the random walk satisfies the following boundary conditions. 
\[
\dfrac{-2}{d(x,y)} \leq \kappa(x,y) \leq \dfrac{2}{d(x,y)}.
\]
\end{lemma}

\proof
Let $x$, $y$, $u$, and $v$ be arbitrary points from $M$ such that both $m_x(u)$
and $m_y(v)$ are positive. Since $m$ is a distance-one random walk, 
$d(u,v) \leq d(x,y) + 2$. Hence, 
$W(m_x,m_y) \leq \sum p_u d(u,v) \leq (d(x,y)+2)\sum p_u = d(x,y) + 2$, 
where the sum is taken over a correspondence between the set of $u \in N(x)$ and 
$v \in N(y)$. So, $\kappa(x,y) \geq - 2/d(x,y)$. The lower bound follows 
similarly from $d(u,v) \geq d(x,y) - 2$.
\endproof

Note that this lemma can be generalised to {\em distance-$d$} random walks, 
which are those satisfying $m_x(y) = 0$ for all $x$ and $y$ such that 
$d(x,y) > d$. In this case, the curvature boundaries are 
\[
-\dfrac{2d}{d(x,y)} \leq \kappa(x,y) \leq \dfrac{2d}{d(x,y)}.
\]
For one needs to notice that in the notations of the lemma, 
$d(u,v) \leq d(x,y) + 2d$. 

As we will see in the next few lemmas, these boundaries can be improved for 
certain random walks on $\dts$. 

\begin{lemma}\label{uniformUpper}
Let $T$ and $R$ be adjacent trees in $\dts$. Then the curvature of the $\dts$
space with a uniform random walk satisfies 
\[
\kappa(T,R) \leq \dfrac{1}{3(n-2)}.
\]
\end{lemma}

\proof
To maximise the curvature $\kappa(T,R)$, we have to minimise $W(m_T,m_R)$. 
The latter is minimised when the probability mass on trees $E \in N(T)$ 
such that
$d(E,R) \leq d(T,R)$, is maximised. Since $d(T,R) = 1$, it follows from 
Lemma~\ref{intersecNeighb} that this probability mass is positive only
when $|N(T) \cap N(R)| = 1$. It follows from Lemma~\ref{curvBoundGeneral} that
the maximal mass we can allocate under a uniform random walk to the tree in 
$N(T) \cap N(R)$ is $\frac{1}{3(n-2)}$. The lemma follows. 
\endproof

This lemma provides a tighter upper bound for the curvature than 
Lemma~\ref{curvBoundGeneral} when the number of taxa $n$ is large enough for
the inequality $d(T,R) \leq 4(n-2)$ to be satisfied. 

It is easy to generalise the lemma to the uniform $p$-lazy random walk. 
\todo{I assume $m_x(x) = 1-p$.}
Indeed, by looking at the proof at the lemma, one can notice that the curvature
between adjacent trees $T$ and $R$ under a uniform $p$-lazy random walk 
satisfies 
\[
\kappa(T,R) \leq \frac{p}{3(n-2)}.
\]

Note that Ollivier~\cite{Ollivier2009-cj} defines the curvature of a metric 
space with a uniform $p$-lazy random walk (for positive $p$) by 
\[
\kappa(x,y) = \frac1p (1 - \frac{W(m_x, m_y)}{d(x, y)}). 
\]

In this case the curvature between adjacent trees in $\dts$ with a uniform 
$p$-lazy random walk (for arbitrary $p$) is bounded from above by
\[
\frac{1}{3(n-2)}.
\]

We continue with lower bounds on the curvature of $\dts$ space with uniform lazy
random walks, where we follow 
Ollivier~\cite{Ollivier2009-cj} and divide the curvature of a $p$-lazy random 
walk by $p$ when $p$ is positive, as explained above.  
\todo{
What does Lemma~\ref{uniformUpper} say about $\dts$- and $\tau$-spaces? 
In $\tau$-space, $\kappa(T,R) \leq 0$~\cite{Gavryushkin2014-bw} for some 
random walk. 
For which one?
}

\begin{lemma}\label{uniformLower}
Let $T$ and $R$ be adjacent trees in $\dts$. Then the curvature of the $\dts$
space with a $p$-lazy uniform random walk satisfies
\[
\kappa(T,R) \geq -\frac{3}{n-2}.
\]
\end{lemma}

\proof
Let $T$ and $R$ be two NNI-adjacent trees. To minimise the curvature, we have
to maximise $W(m_T, m_R)$. Since $d(T, R) = 1$, the trees $T$ and $R$ can be
chosen so that there are 
\todo{Explain this.}
$8$ trees $E$ in $N(T)$ for which 
$d(E, N(R)) > d(T, R)$. 
For the rest of the trees $S$ from $N(T)$, we can assume $d(S, N(R)) = 1$.
The total number of elements of $N(T)$ should be taken to be $2(n-2)$ to 
maximise the probability mass under consideration.
\todo{This is not quite a proof. One has to count unpairable trees instead. 
See Lemma~\ref{uniformLower} too.}
Hence, 
\[
W(m_T,m_R)\leq (1 - p - \frac{p}{2(n - 2)}) + 
8 \cdot 2 \cdot \frac{p}{2(n - 2)} +
(2(n - 2) - 9)\frac{p}{2(n-2)} =
\]
$1 + \displaystyle\frac{3p}{n-2}.$ 
Hence, $1 - W(m_T,m_R) \geq - \displaystyle\frac{3p}{n-2}.$
\endproof

\begin{lemma}
Subtract $2/3$ to get a lower bound on the curvature of the
uniform prior Metropolis-Hastings random walk.
\end{lemma}

\proof
Same reasoning as in~\cite{Whidden2015-es}. 
\endproof

Although the following proposition immediately follows from 
Lemma~\ref{uniformUpper} and Lemma~\ref{uniformLower} for the $\dts$ space,
we would like to state and prove it in the more general setting applicable 
to many other spaces, e.g.\ the rooted SPR space~\cite{Whidden2015-es}. 

\begin{proposition}
Let $(M_n,d_n)_{n \in \omega}$ be a sequence of finite metric spaces and 
$(x_n, y_n)$ a sequence of adjacent vertices, that is $d_n(x_n,y_n) = 1$,
from $M_n$ such that
\begin{enumerate}[(1)]
\item $\big|N(x_n) \cap N(y_n)\big| = o(|N(x_n)|).$ 
\item $\big||N(x_n)| - |N(y_n)|\big| = o(|N(x_n)|).$ 
\item $\big|\{(x,y) \mid x \in N(x_n),~ y \in N(y_n),~ d(x, y) \geq 2\}\big| 
= o(|N(x_n)|).$
\end{enumerate}

Then $\lim\limits_{n \to \infty} \kappa(x_n, y_n) = 0.$
\end{proposition}

\proof

\endproof

\begin{question}
Assume some (e.g.\ uniform, lazy, ...) random walk. What are the $m$ and $M$ 
such that 
\[
m(\deg x,\deg y, \ldots) \leq \kappa(x,y) \leq M(\deg x, \deg y, \ldots)? 
\]
\end{question}

\section{Some other space}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We now extend the space of possible moves by including branch length moves. 
In general, such moves should allow the branch length to be any positive real 
number, but this setting seems to require quite sophisticated techniques for 
computing the curvature and hence is a direction of future research. 
Instead, here we allow branch length (or rather $\tau$-coordinates) 
to be of two possible values: long (denoted by $\Lambda$) and short (denoted 
by $\lambda$). Node that the number of possible `branch lengths' can be 
generalised to any finite set $\lambda_1,\ldots,\lambda_s$\todo{It's worth 
pointing out explicitly what the change in what result will be.}.

More precisely, we consider a graph $\tN$ on the set of ranked rooted tree 
topologies (which we call simply trees from now on) with all leaves of rank 
$0$ and all intervals between nodes of the tree marked by $\Lambda$ or
$\lambda$. Two trees are adjacent in $\tN$ if and only if they are in 
adjacent orthants in $\tau$-space~\cite{Gavryushkin2014-bw} and the interval corresponding 
to the boundary in $\tau$-space is marked by $\lambda$ in both trees, 
or they are of the same ranked topology and there 
exists precisely one interval which is marked by different symbols in 
the two trees. 

The intuition behind this notion is that one move corresponds to either 
a $\tau$-move from a short interval to a new short interval or a change 
of the length of precisely one interval. 

First, we consider a uniform (lazy) random walk, where given a tree $T$ 
we do nothing with probability $p$, where $0\leq p\leq 1$ is the probability of 
\href{https://academichelp.net/wp-content/uploads/2014/01/laziness.jpg}{laziness},
and uniformly move to a neighbouring tree with probability $1-p$. 

\begin{lemma}
Let $T$ be a ranked tree on $n>2$ leaves. Then \[n-2\leq \deg(T)\leq3(n-2).\] 
\end{lemma}

\proof
Obvious.
\endproof

\begin{lemma}
\begin{enumerate}[(1)]
\item $deg(T)-deg(R) \leq 2(n-2).$
\item $\min\limits_{T,R}\dfrac{\deg(T)}{deg(R)} = \dfrac13$ for all $n.$
\end{enumerate}
\end{lemma}

\proof
Follows from previous Lemma. 
\endproof

These two lemmas remain unchanged if we increase the number of branch lengths. 

Other lemmas follow similarly too. 

Several important proposal mechanisms used in phylogenetic Bayesian inference by 
popular software packages such as BEAST2~\cite{beast2} favour topological moves
or tree moves depending on various conditions. All tree moves I have been 
considering so far do not make an explicit distinction between topological 
changes and branch length changes. To address this issue, we consider the
following tree move that explicitly allows distributing the acceptance 
probability between topological and branch length moves. 

{\bf Lazy walk.} Let $p$ be a laziness probability, that is, we do nothing 
with probability $p$ and distribute the rest of probability $1-p$ as follows. 
We decide first on what type of move we want to perform: choose a topological 
move with probability $q$ and a length move otherwise, that is, $q \leq 1-p$
and the probability of a length move is $1-p-q$. The proposal is rejected if
a topological move is impossible. 

{\bf tau move.} Choose a coordinate uniformly at random. Increase the
coordinate by $1$ with probability $p$ and decrease it by $1$ otherwise.
If the coordinate becomes $0$, resolve the multifurcation uniformly at
random and set the new coordinate to $1$. Note that this mechanism 
does not bound edge lengths from above favours topological moves when 
$p<1/2$. 

{\bf MH lazy walk.} Propose a tree in the one-neighbourhood uniformly at random. 
Accept the proposal with probability 
$\min(1, \dfrac{|N(T_{old})|}{|N(T_{new})|})$. 

\bibliography{curvatureNNI}
\bibliographystyle{alpha}

\end{document}
