\documentclass{amsart}

\synctex=1

\usepackage{amsmath,amsthm,amssymb}
\usepackage{todonotes}
\usepackage[notref,notcite]{showkeys}
\usepackage{enumerate}
\usepackage{url}
\usepackage[hidelinks]{hyperref}
\usepackage{graphicx}
\usepackage[style=authoryear-icomp,ibidtracker=false]{biblatex}
\usepackage{etoolbox}

\addbibresource{curvatureNNI.bib}

\newtheorem{lemma}{Lemma}
\newtheorem{question}[lemma]{Question}
\newtheorem{proposition}[lemma]{Proposition}
\newtheorem{corollary}[lemma]{Corollary}
\newtheorem{theorem}[lemma]{Theorem}
\newtheorem{problem}[lemma]{Problem}

\theoremstyle{definition}
\newtheorem{example}[lemma]{Example}
\newtheorem{conjecture}[lemma]{Conjecture}

\newcommand{\dts}{\mathrm{2DtT}}
\newcommand{\nni}{\mathrm{NNI}}
\newcommand{\rnni}{\mathrm{rNNI}}
\newcommand{\rnniu}{\mathrm{rNNIu}}
\newcommand{\dtt}{\mathrm{DtT}}
\newcommand{\dttu}{\mathrm{DtTu}}
\newcommand{\MH}{\mathrm{MH}}
\newcommand{\ric}{\operatorname{ric}}
\newcommand{\rt}{\operatorname{rt}}
\newcommand{\tp}{\operatorname{tp}}
\newcommand{\W}{\mathcal{W}}
\newcommand{\M}{\mathcal{M}}
\newcommand{\dom}{\operatorname{dom}}
\newcommand{\G}{\mathcal{G}}

\renewcommand{\O}{\mathcal{O}}

\newtoggle{curvatureON}
\togglefalse{curvatureON}

\sloppy

\begin{document}

\title{Random walks over discrete time-trees}

\author{Alex Gavryushkin}
\address{Department of Computer Science, The University of Auckland, New Zealand}
\email{a.gavruskin@auckland.ac.nz}

\author{Chris Whidden}
\address{Program in Computational Biology, Fred Hutchinson Cancer Research Center, Seattle, WA 98109}
\email{cwhidden@fredhutch.org}

\author{Frederick A Matsen IV}
%\address{Program in Computational Biology, Fred Hutchinson Cancer Research Center, Seattle, WA 98109}
\email{matsen@fredhutch.org}


\begin{abstract}
We introduce and study a hierarchy of discrete approximations of the space of time-trees, with $\nni$-space being the roughest approximation.
We design a heuristic for generating these spaces and study, analytically and computationally, graph-theoretic and computational properties of the spaces.
\iftoggle{curvatureON}{
We also investigate the Ricci-Ollivier curvature of basic random walks on the spaces.
}{}
\end{abstract}


\maketitle


\section{Introduction}
The last ten years have seen an explosion of methods using sequence data to infer demographic model parameters by sampling phylogenetic trees \autocite{Kuhner1995-mj,Kuhner1998-tq,Kuhner2000-af,Beerli2001-sc,Kuhner2006-vx,Drummond2002,Drummond2005-ks,Drummond2006-oa,Minin2008-wz}.
These methods have had an especially significant impact in the study of quickly evolving organisms such as viruses, such as inferring historical epidemic spreading rates.
For example, such methods can be used to infer time to a most recent common ancestor of human HIV group M viruses \autocite{Worobey2008-rt,Baele2013-op}.
Thus the \emph{time-tree}---a rooted phylogenetic tree with all internal nodes equipped with absolute divergence dates---has become an important object of interest.
This is in contrast to classical phylogenetic trees in which branch lengths quantify the amount of molecular substitution along a branch.
Posterior distributions on both time-trees and classical trees are estimated using Markov chain Monte Carlo \autocite{Mau1997-sq,Yang1997-gv,Drummond2002}.
Although Markov chain Monte Carlo (MCMC) is guaranteed to sample from the true posterior given an infinite run time, it is important to understand mixing properties of the chain, which determine sampling properties for a finite time run.

\begin{figure}[ht]
\centering
\includegraphics[width=0.7\textwidth]{timeTree.eps}
\caption{Time-tree on $6$ leaves.
Time is measured by non-negative real numbers.
If time is restricted to integers, the tree becomes a discrete time-tree.}
\label{timeTree.eps}
\end{figure}

The mixing properties of phylogenetic MCMC have, in the classical unrooted case, been a major area of research from both the theoretical perspective of mixing time bounds \autocite{Mossel2005-ly,Mossel2006-fo,Stefankovic2011-hu,spade2014note} and the practical perspective of performance on real data \autocite{beiko2006searching,Ronquist2006-fv,lakner2008efficiency,Whidden2015-yi}.
This research has focused on mixing over the set of discrete phylogenetic tree graph structures, which is the primary obstruction to MCMC convergence.
Classical phylogenetic trees discretize naturally as simply the graph structure underlying that phylogenetic tree.
MCMC moves between classical phylogenetic trees are typically defined in terms of this discretization.
Common moves include \emph{subtree prune and regraft} (SPR) moves, which cut a subtree off and reattach it at another location, and the subset of SPR moves called \emph{nearest-neighbor interchange} (NNI) moves.
On the other hand, moves between time-trees are also defined in terms of their timing information.
For example, \textcite{Hohna2008-vl} show that SPR-like moves that reattach subtrees at the same divergence time are more effective than ones that do not.
This sort of move cannot be expressed using the type of discretization used thus far in which all continuous information is lost, and so the previous work on MCMC mixing cannot be applied.

However, one can discretize time-trees in a way that does preserve some of the information.
For example, by retaining the order of internal nodes backward in time one obtains a so-called \emph{ranked tree} \autocite{Semple2003-nj}.
A sequence of time-trees sampled using MCMC projects to a collection of movements on a graph in which each vertex is a discretized time-tree and each edge is a discretized version of an MCMC move on time-trees.

Another possible way to make a less rough approximation of a time-tree is to allow the time periods between nodes of the tree to take only finitely many possible values.
The graph built on such trees provides a further refined discretization of the space of time-trees.
We call such a graph a \emph{discretized time-tree graph}.

Although inferential algorithms have been doing MCMC on time-trees for over a decade, and graphs corresponding to discretizations of unrooted tree space have been studied for even longer, we are not aware of any work defining graphs from discretization of time-tree space or doing analysis of random walks thereupon.
Having such a theory would provide a foundation for understanding the behavior of MCMC algorithms on time-trees, as has been done previously for graphs associated with unrooted phylogenetic trees.
Up to now, the only discretization of time-tree space that has been studied is that of ranked trees \autocite{Ford2009-qi,Lambert2013-mr}, and that hasn't been from a graph-theoretic perspective.

In this paper we explore various discretized time-tree graphs, derive some of their properties, initiate the mathematical study of random walks on these spaces, and compare these results to those in the classical phylogenetic setting.
In particular, we focus on ranked trees, discretized time-trees (as defined above), and the ultrametric versions of those types of trees.
\iftoggle{curvatureON}{
We study Ricci-Ollivier curvature \autocite{Ollivier2009-cj} of Markov chains on these graphs, a formalism which quantifies to what extent random walking brings unit balls together.
This formalism has recently been applied to Markov chains on graphs of classical phylogenetic trees \autocite{Whidden2015-es}.
}

The paper is organized as follows.\\
1.\ a section on 1-neighborhood sizes\\
2.\ a section on larger neighborhood sizes and diameter\\
3.\ degreeBounds, intersecNeighb, and max good neighbors\\
\iftoggle{curvatureON}{
4.\ curvature.\\
}{}
If there's something interesting to say about distances on rNNI, then add that too.
\todo{Write (or drop) this para when paper is done.}


\section{Technical introduction}
\iftoggle{curvatureON}{
\subsection{Discrete time-trees}
}{}

Throughout the paper by a (phylogenetic) \emph{tree} we mean a rooted binary tree with designated leaves, that is, an undirected acyclic graph with the following properties:
(1) all nodes have degree $1$, $2$, or $3$; (2) there exists exactly one node of degree $2$, this node is called the \emph{root} of the tree; (3) all nodes of degree $1$ are marked by different constants, these nodes are called \emph{leaves}.
The \emph{parent} of a node $x$ in a tree is the unique node $y$ that is both adjacent to $x$ and closer to the root of the tree than $x$.
Every node of a tree has a parent except for the root.

We fix the number of leaves of the trees and denote this number by $n$ throughout the paper.
We also assume that each tree with $n$ leaves uses the same fixed set of $n$ constants to mark the leaves.
Hence, we say that two trees are isomorphic if they are isomorphic as graphs and the isomorphism maps leaves marked by the same constant to each other.
We identify isomorphic trees.

By a \emph{time-tree} (see Figure~\ref{timeTree.eps}) we mean a tree with an absolute time associated with every node of the tree: for internal nodes these are (typically estimated) divergence times and for leaves---(typically known) sampling times.
By ``absolute'' we clarify that these are not relative times, but rather actual times that can be put on a calendar.
We assume that time progresses forward, towards larger times, from the root to the leaves.

A \emph{discrete time-tree} is a tree such that all its nodes are assigned distinct times from the set of non-negative integers such that every node has a smaller time than its parent (Figure~\ref{timeTree.eps}).
Note that this implies that for every pair of nodes $x,y$ if the shortest path from the root to $x$ passes $y$ then the time of $y$ is greater than the time of $x$.
The \emph{rank} of a node is the number of nodes in the tree with strictly smaller time.
We say that a pair of nodes $x,y$ of a discrete time-tree is an \emph{intercoalescent interval} if there exists no node $z$ such that the time of $z$ is between the time of $x$ and $y$.
The difference between the times of $x$ and $y$ is called the \emph{length} of the interval $x,y$.
The \emph{rank} of a node is its position in the total ordering of nodes with respect to times.
We identify two discrete time-trees if they are isomorphic as trees and the isomorphism preserves ranks of the nodes as well as intercoalescent interval lengths.

We are now ready to introduce a hierarchy of discrete time-trees.

%EM My preference would be to only use "space" for collections of trees with a continuous component.
At the bottom level of our hierarchy is the well-known $\nni$ space\footnote{We use the words ``space'' and ``graph'' interchangeably.}.
$\nni$ is a graph with the vertices being all trees on $n$ leaves.
Two trees $T$ and $R$ are adjacent in $\nni$ if there exists an edge $e$ in $T$ and an edge $f$ in $R$ such that both edges are not adjacent to a leaf and the graph obtained from $T$ by suppressing $e$ is isomorphic to the graph obtained from $R$ by suppressing $f$.
We denote this space by $\dtt_0$.

Level $m > 0$ of the hierarchy is the following graph $\dtt_m$.
The set of vertices of the graph is the set of all discrete time-trees on $n$ leaves such that every intercoalescent interval has its length not greater than $m$.
Two trees $T$ and $R$ are adjacent in $\dtt_m$ if $R$ can be obtained from $T$ by one of three operations: a \emph{length move performed on interval} $I$, \emph{swapping the rank of two nodes $x$ and $y$} or an \emph{$\nni$ move performed on interval $I$} (Figure~\ref{DtT.pdf}).
A length move changes the length of $I$ by 1.
Swapping the rank of two nodes $x$ and $y$ swaps their times.
$R$ can be obtained from $T$ by an $\nni$ move if there exists intercoalescent intervals $I$ and $J$ of length $1$ in $T$ and $R$, respectively, such that the graphs obtained by suppressing $I$ and $J$ are isomorphic and the isomorphism preserves the lengths of the intercoalescent intervals.

A graph can also be seen as a metric space where the distance is given by the length of a shortest path, so we will refer to $\dtt_m$ as both.
\todo[inline]{The general identifier $\dtt$ is used throughout the paper (e.g. in the next figure caption) but not defined. Should we say here that $\dtt$ refers to $\dtt_m$ with an arbitrary $m$ for simplicity or switch all of the $\dtt$'s to $\dtt_m$?}

\begin{figure}[ht]
\centering
\includegraphics[width=0.8\textwidth]{DtT.pdf}
\caption{All possible moves performed on interval $I$.
Assuming that the length of every intercoalescent interval is either $1$ or $2$, the outer trees are all possible neighbors in $\dtt$ of the tree in the middle corresponding to interval $I$.}
\label{DtT.pdf}
\end{figure}

In other words, by going from one tree to an adjacent tree in the $\dtt_m$ graph we can either change the length of one intercoalescent interval by one unit, swap the rank of two nodes, or send the length of an intercoalescent interval of minimal length down to zero and then resolve the multifurcation to either of the two possible trees.
In the latter case, the new interval is of minimal length.
See Figure~\ref{dts_neighbors.pdf} for an example of the full variety of possible moves.

\begin{figure}[ht]
\centering
\includegraphics[width=0.7\textwidth]{dts_neighbors.pdf}
\caption{Trees $T$ and $R$ are at $\dtt_2$ distance $3$.
To move from $T$ to $R$ in $\dtt_2$, one must decrease the length of interval $I$, swap the ranks of nodes $A$ and $C$ bounding interval $J$, and perform an NNI move on interval $K$, resolving nodes $C$ and $D$.}
\label{dts_neighbors.pdf}
\end{figure}

Note that $\dtt_0$ can be obtained from $\dtt_1$ by ``forgetting'' ranks and $\dtt_1$---from $\dtt_m$ by forgetting lengths.
In general, the graph structure for $m > 1$ can be understood by considering all diagrams as in Figure~\ref{DtT.pdf} and introducing an extra layer on nodes in the tail on the left of the diagram.
\todo{Can this be stated (and proved?) formally?}

This hierarchy can be seen as a set of discrete refinements of the full space of phylogenetic time-trees, where intercoalescent intervals can take an arbitrary real value.
Indeed, if we consider
$\tau$-space\footnote{Conveniently, the discretized versions of $\tau$- and $\mathrm t$-space from \autocite{Gavryushkin2014-bw} coincide.}
defined by \textcite{Gavryushkin2014-bw}~\todo{this is an odd reference format with the first name for one author.} and allow the real-valued parameters (length intercoalescent intervals) to take only $m$ possible values from $1,\ldots,m$ then we get $\dtt_m$.
In this case, $\dtt_0$ is the graph with the vertices being the cubes of $\tau$-space and the adjacency relation being the relation of ``have a shared facet of co-dimension $1$''.
%EM Relating to these notions of tau and t space, would it be worth describing, in broad strokes, how these graphs relate to BHV space directly?
%EM Readers may be more familiar with that space.
%EM It seems to me that one could do so by describing how the discrete time trees are a subset of the integer lattice on each orthant, and then we put an edge between every pair of vertices that are less than some distance apart?

The $\dtt_m$ space on ultrametric trees, that is the set of trees such that each leaf has the same time, is denoted by $\dttu_m$.
The $\dtt_1$ space is denoted by $\rnni$ and called \emph{ranked NNI} space; on ultrametric trees we will denote it $\rnniu$.
All of these can be considered as either a graph or a metric space, and we will refer to them as both.

By $\ell_T(I)$ we denote the length of intercoalescent interval $I$ in tree $T$.
\todo{Check if we use this notation and put it in correct place.}

\iftoggle{curvatureON}{
Furthermore, as $\nni$ space of unrooted tree topologies with $n-1$ leaves is isomorphic (as a graph) to the $\nni$ space of rooted tree topologies with $n$ leaves, all our results on curvature immediately imply their counterparts in unrooted NNI space.
We omit from the text the exact formulations for unrooted trees, as they can be obtained in the obvious way.


\subsection{Ricci-Ollivier curvature}
A random walk on a metric space is defined by its proposal mechanism, which is a functional $m$ that maps points of the space to the set of measures on this space \autocite[see][]{Ollivier2009-cj}.
In other words, for every point $v$ in the space, $m(v,w)$, which we denote by $m_v(w)$, is the probability of the random walk moving from $v$ to $w$ in one step.
Given a metric space $(V,d)$, a \emph{coupling} $\mu$ between two measures $\mu_1$ and $\mu_2$ on $V$ is a probability measure on the set of pairs of points $V \times V$ that is $\mu_1$ after marginalizing over the second component, and $\mu_2$ after marginalizing over the first component, that is, $\sum\limits_{y \in V}\mu(x,y) = \mu_1(x)$ and $\sum\limits_{y \in V}\mu(y,x) = \mu_2(x)$ for all $x \in V$.
A coupling can be seen as a scenario of transforming the measure $\mu_1$ on $V$ to $\mu_2$ by looking at $\mu(x,y)$ as the probability mass that has to be moved from $x$ to $y$ under the scenario.

Using these notations, we define the \emph{work} $\W_\mu$ needed to be done to transform $\mu_1$ to $\mu_2$ via coupling $\mu$ by setting
\[
\W_\mu(\mu_1,\mu_2) = \sum\limits_{x,y\in V}\mu(x,y) d(x,y).
\]
Let $\M$ be the set of all couplings between measures $\mu_1$ and $\mu_2$.
Then the \emph{earth mover's distance} $W$ between $\mu_1$ and $\mu_2$ is defined to be $W(\mu_1,\mu_2) = \inf\limits_{\mu\in\M}\W_\mu(\mu_1,\mu_2)$.

We are now ready to introduce two curvature notions that we are studying in this paper.
Let $m$ be a random walk on a metric space $(V,d)$.
Then the \emph{coarse Ricci-Ollivier curvature} between two points $x$ and $y$ from $V$ with the random walk $m$ is
\[
\kappa(m;x,y) = 1 - \frac{W(m_x,m_y)}{d(x,y)}
\]

Another important notion of this paper is that of asymptotic curvature.
The following random walk $m$ is called a \emph{uniform $p$-lazy random walk} on a metric space $(V,d)$:
\[
m_x(y) =
\begin{cases}
1-p			& \mbox{ if } x=y \\
0   			& \mbox{ if } d(x,y) > 1 \\
\dfrac{p}{|N(x)|}	& \mbox{ if } d(x,y) = 1 \\
\end{cases}
\]
where $x,y \in V$ and $N(x) = \{y \mid d(x,y) = 1\}$.

We follow \textcite{Loisel2014-gu} and define \emph{asymptotic Ricci-Ollivier curvature} $\ric$ between points $x,y$ from a metric space with uniform $p$-lazy random walk $m$ by
\[
\ric(x,y) = \lim_{p\to0} \frac{\kappa(m;x,y)}{p}
\]

One of the central properties of Ricci-Ollivier curvature is that the curvature is a local property \autocite{Ollivier2009-cj}.
For finite metric spaces that means that for all distinct $u$ and $v$,
\[
\inf\{\kappa(m;x,y)\mid d(x,y) = 1\} \leq \kappa(m;u,v).
\]
Hence, we define the \emph{coarse Ricci-Ollivier curvature of a metric space} with a random walk $m$ to be $\inf\{\kappa(m;x,y)\mid d(x,y) = 1\}$ and the \emph{asymptotic Ricci-Ollivier curvature of a metric space} to be $\inf\{\ric(x,y)\mid d(x,y) = 1\}$.
}{}


\section{Geometry and complexity of space of discrete time-trees}

We begin by considering the shortest path distance on the graphs.
It is well-known that computing distances is NP-hard in $\nni$ space \autocite{Dasgupta2000-xa}.
Hence the following question is natural.

\begin{problem}
What is the complexity of computing the distance between two discrete time-trees?
\end{problem}

Although this problem remains open, we make progress towards the solution by establishing several geometric and algorithmic properties of these graphs.
First, we demonstrate in the following example that even for caterpillar trees the complexity cannot be derived from the complexity of $\nni$ distance.

\begin{example}
Let $T$ be the ultrametric tree $((((((1, 2), 3), 4), 5), 6), 7)$ and $R$ be the ultrametric tree $((((((1, 4), 5), 6), 2), 3), 7)$.
Then a shortest $\nni$ path is given by first making a cherry $(2,3)$, then moving the cherry up to the split $1456 \mid 7$, and then resolving the cherry back.
In $\rnniu$ this path is not shortest, and one shortest path moves the parents of $2$ and $3$ up independently.

\begin{figure}[ht]
\centering
\includegraphics[width=\textwidth]{NNI_VS_rNNI.pdf}
\caption{Shortest paths in $\nni$ may not be shortest in $\rnni$.}
\label{NNI_VS_rNNI.pdf}
\end{figure}
\end{example}

With this example in mind, it is not hard to see that the set of trees of the form $(\ldots(1, i_2), \ldots, i_{n-1}), n)$, where $\{i_2, \ldots, i_{n-1}\} = \{2, \ldots, n-1\}$, is convex in the space of discrete time-trees and is not convex in $\nni$.~\todo{Can you explain why this is in a couple of sentences?}
This basic difference in the structure of the two spaces suggests that the complexity of computing the distance is likely to be different in the two spaces.

We proceed by establishing basic geometric properties of discrete time-trees.


\subsection{Sizes of neighborhoods}

\begin{lemma}[\textcite{Semple2003-nj}]\label{spaceSizes}
Let $|V|$ be the number of vertices in the graph, then $|V|$ is equal to
\begin{align*}
& (n-1)! \cdot n! \cdot n!	&& \mbox{in $\dtt$,}\\
& (n-1)! \cdot n!		&& \mbox{in $\dttu$,}\\
& \frac{(n-1)!n!n!}{2^{n-1}}	&& \mbox{in $\rnni$,}\\
& \frac{(n-1)!n!}{2^{n-1}}	&& \mbox{in $\rnniu$, and}\\
& (2n - 3)!!			&& \mbox{in $\nni$.}
\end{align*}
\end{lemma}

We continue with the following bounds on the sizes of one-neighborhoods of various discretization of the space of time-trees.
We will use these bounds to estimate the curvature of various random walks later in the paper.

\begin{lemma}\label{neighBound}
Let $T$ be a tree on $n$ leaves.
Then
\begin{align*}
& 2(n-1) \leq \deg(T) \leq 5n-6	&& \mbox{in $\dtt$,}\\
& n-1 \leq \deg(T) \leq 3n-5	&& \mbox{in $\dttu$,}\\
& n-1\leq \deg(T) \leq3n-4 	&& \mbox{in $\rnni$,}\\
& n-1 \leq \deg(T) \leq 2n-4 	&& \mbox{in $\rnniu$, and}\\
& \deg(T) = 2n-4 		&& \mbox{in $\nni$.}
\end{align*}
All bounds are tight.
\end{lemma}

\proof
The lower bound in $\dtt$ space is attained by any tree with all intercoalescent intervals being of length $m$.
In this case, $\deg(T)$ is simply the number of intercoalescent intervals, since every intercoalescent interval adds $1$ to the total degree of the tree.
Other trees have the same or more possible intercoalescent interval changes, showing that this is a lower bound.
The upper bound is attained by a caterpillar tree with all intervals short and no coalescent event being younger than a taxon.
In this case, $\deg(T)$ is bounded by the sum of the $2(n-1)$ possible interval length changes, the at most $2(n-2)$ NNI neighbors, and at most $n$ rank changes that can occur between the $n$ taxa.
In total, $\deg(T) \le 2(n-1) + 2(n-2) + n = 5n-6$.
Note that this is an upper bound indeed, as each of the $2(n-2)$ intervals excluding the most recent can contribute either a rank change or $2$ NNI moves.
The caterpillar tree described above maximizes the number of intervals that contribute $2$ NNI moves and enables the rest of intervals to contribute a rank change.

For ultrametric trees, the number of intercoalescent intervals is $n-1$, hence they add $n-1$ to the degree of the caterpillar tree from interval changes.
The number of intervals on which an NNI move is possible is $n-2$ for ultrametric trees, hence they contribute $2(n-2)$ to the degree.
In total, this gives the upper bound of $3n-5$ for ultrametric trees.

Since every NNI move results in two neighbors, the equality $\deg(T) = 2(n-2)$ follows for $\nni$ space.
Indeed, it is not hard to see that the set of NNI moves that only consider moving a subtree to its aunt captures the full set of NNI neighbors with no duplicates.
The neighborhood size then follows because the root and its two children have no aunt.

The lower bound in $\rnni$ space is attained by the caterpillar-tree where taxa get ranks $0, 1, 3, 5, \ldots, 2n-3$ and internal nodes get ranks $2, 4, 6, \ldots, 2n-2$.
In other words, the coalescent events alternate with the taxa in the ranked topology of the tree so that if we parse the tree from the present to the past, we meet the nodes in the following order: taxon, taxon, coalescence, taxon, coalescence, taxon, coalescence, and so on.
In this case, intervals bounded by a taxon from below add nothing to the degree of the tree and intervals bounded from below by an internal node add one each, hence $n-1$ in total.
The upper bound for both $\rnni$ and $\rnniu$ is obtained in the same way as for $\dtt$ space.

For the lower bound in $\rnniu$, we note that the oldest intercoalescent interval (the one adjacent to the root) necessarily contributes $2$ to the degree.
Hence the lower bound can be reached by a tree such that no other interval contributes more than 1.
The degree of such a tree is $n-1$ in $\rnniu$.
\endproof

The following theorem bounds the sizes of neighborhoods.
\todo{Does this improve the best known bound for NNI?
If so, add this to the inro.}

\begin{theorem}\label{neighSizeTh}
The number of trees within distance $r$ from any given tree is at most
\begin{itemize}
\item[] $3^{n+2r-1}$ in $\rnniu$,
\item[] $3^{2n+2r-2}$ in $\rnni$,
\item[] TBA in $\dtt$,
\item[] TBA in $\dttu$.
\end{itemize}
\end{theorem}

\proof
We prove the theorem in $\rnniu$ and it will follow similarly in the other three spaces.
The proof employs the technique from \autocite{Sleator1992-bp} for counting paths in a graph: we first apply Theorem~2.3 of \textcite{Sleator1992-bp} and then improve the bound using specific properties of the $\rnniu$ graph.

We first need to introduce the \emph{graph grammar} for $\rnniu$.
Recall that a graph grammar consists of a finite set of productions $\{L_i \to_i R_i\}$, where $L_i$ and $R_i$ are connected undirected edge-end labeled graphs and $\to_i$ is a one-to-one map between half-edges of $L_i$ and those of $R_i$.
The productions are then applied to the starting tree $T$ to derive all possible trees at $\rnniu$ distance up to $r$ from $T$.
A production is said to be \emph{ready} at a stage $s$ of the derivation if the running tree at stage $s$ has a subgraph isomorphic to the left side $L_i$ of the production.
A ready production can be applied to the running tree by destroying all nodes corresponding to the left side of the production under the isomorphism and replacing them with the right side $R_i$ of the production.
The map $\to_i$ of the production then says how to reconnect the right side of the production to the half-edges of the running tree that were created after the destruction.
Thus obtained tree is the new running tree for the next stage $s+1$ of the derivation.
See \autocite{Sleator1992-bp} for precise definitions and details.

The graph grammar for $\rnniu$ is the grammar $\Gamma$ shown on Figure~\ref{grammar_rNNIu.pdf}.
Note that the definition of a graph grammar requires the left sides $L_i$ to be connected and we have a disconnected left side in the third production.
This does not cause a problem because the nodes on the left side of the production must be of consecutive ranks.
(One could think of those nodes as being adjacent via a second type adjacency relation on top of the first type adjacency relation given by the branches of the tree.)

\begin{figure}
\centering
\includegraphics[width=0.7\textwidth]{grammar_rNNIu.pdf}
\caption{Graph grammar $\Gamma$ for $\rnniu$.
Maps $\to_i$ are shown by dashed lines.
In the first two productions, the edge-ends marked by $2$ and $3$ without dashed lines are mapped to each other: top $3$ to top $3$, $2$ to $2$, bottom $3$ to bottom $3$.
In the last production, edge-ends marked by the same label are mapped to each other.
All pairs of nodes on both sides of each production must be of consecutive ranks.
The first two productions correspond to an $\nni$ move, while the last production corresponds to rank change.}
\label{grammar_rNNIu.pdf}
\end{figure}

The number of vertices in left sides of $\Gamma$ is $6$, the maximum number of vertices in any right side of a production of $\Gamma$ is $2$.
Since the number of internal nodes of a tree on $n$ leaves in $\rnniu$ is $n-1$, directly applying Theorem~2.3 from \autocite{Sleator1992-bp} we get the bound of $7^{n+2r-1}$.

This bound can be improved following the techniques developed in \autocite{Sleator1992-bp} after Theorem~2.3.
Every node of a tree in any application of a production of grammar $\Gamma$ can play either of two roles: top node or bottom node.
Hence to indicate that a pair of nodes is ready for being destroyed and replaced using a production, we must specify which node is the top and which is the bottom.
We use two vertex labels to identify these two roles.
Furthermore, to distinguish which of the two possible $\nni$ moves is applied, we employ another (third) vertex label.
We claim that tree labels $1,2,3$ for the vertices is enough.
We must redefine the notion of readiness to verify this claim.
We say that a pair of consecutive nodes is \emph{ready} if the label of the bottom node is $1$ and the label of the top node is either $2$ or $3$.
If two consecutive nodes are ready and not connected by an edge in the tree, then only the rank move is possible.
If they are, the type of the rank move is determined by the label of the top node.
Hence, this notion of readiness uniquely identifies which of the three productions is applied.
Furthermore, if we want to indicate that a pair of consecutive nodes is never destroyed, we give them identical labels.
Thus, all possible configurations encoded by the six nodes on the left sides of the productions of $\Gamma$ can be encoded using three labels.
This implies that the derivation can be encoded by a ternary sequence of length $n-1+2r$.
Indeed, the first $n-1$ entries of the sequence are needed to encode all possible labelings of the initial tree, plus two entries are needed for each of the $r$ applications of productions because every production creates two new nodes, each of which has to be labeled.
The number of such strings, $3^{n-1+2r}$, gives the desired improved bound.
\endproof


\subsection{Diameter of the space}

Theorem~\ref{neighSizeTh} provides a method for estimating the diameter of the space from below.
Now we estimate the diameter from above.

\begin{lemma}\label{diameterUpperBound}
Let $\Delta(\G)$ be the diameter of graph $\G$.
Then for $n \ge 4$,
\[
\Delta(\rnniu) \le n^2 - 3n - \frac 58.
\]
\end{lemma}

\proof
Let $T$ and $R$ be trees in $\rnniu$.
We show that there exists a path between them of length $\frac{13}{14}n^2 - \frac{11}{4}n - \frac{9}{16}$ or shorter.
We denote the taxa on one side from the root of $T$ by $A$ and the rest of taxa by $B$.
Let $A = A_1 \cup A_2$ and $B = B_1 \cup B_2$ so that the root of $R$ splits the taxa into $A_1 \cup B_1$ and $A_2 \cup B_2$.
Note that all $A_i$'s and $B_i$'s have to be disjoint.
We assume that $|A_1| = |A_2| = |B_1| = |B_2| = \frac{n-1}{4}$ and denote this number by $m$.
We will see later in the proof that this assumption does not restrict the generality of our argument.

We construct the path from $T$ to $R$ proceeding in the following steps.
Let $f(n)$ be the desired upper bound.

\begin{enumerate}[(1)]
\item Move all the nodes adjacent to taxa in $A_2$ on top of all the other nodes in $T$, apart from the root.
The tree restricted to $A_2$ is then a caterpillar tree.
This can be done in $3m^2$ moves.

\item Move the caterpillar tree on $A_2$ to the other side of the root.
This can be done in $\frac12 m^2 + \frac12 m$ moves.

\item Move all the nodes adjacent to taxa in $B_1$ on top of all nodes apart from those adjacent to taxa in $A_2$ and the root.
The tree restricted to $B_1$ is then a caterpillar tree.
This can be done in $2m^2$ moves.
(We refer to this type of action as to ``move $B_1$ in between $A_2$ and $A_1 \cup B_2$''.)

\item Swap the caterpillars on $A_2$ and $B_1$.
This can be done in $m^2$ moves.

\item Move the caterpillar tree on $B_1$ to the other side of the root.
This can be done in $\frac12 m^2 + \frac12 m$ moves.

\item Move $B_2$ in between of $A_2$ and $A_1$.
This can be done in $m^2$ moves.

\item Convert the subtree restricted to $A_1$ to that in $R$.
Then convert the subtree restricted to $B_2$ to that in $R$.
This takes $2f(n/4)$ moves.

\item Move $B_2$ to its place in $R$.
This takes $m^2$ moves.

\item Move $A_2$ to its place in $R$.
This takes $2m^2$.

\item Move $B_1$ to its place in $R$.
	This takes $3m^2$\todo[inline]{I don't quite follow. Are you assuming that the $A_i$'s and $B_i$'s are distinct subtrees in $R$? Don't you need to distribute their elements once you have them on the correct side of the root?}.
\end{enumerate}

In total we have a recursive equation $f(n) = 14m^2 + m + 2 f(n/4)$.\\
The solution to this equation~\todo{How did you solve it?} is
\[
f(n) = n^2 - 3n - \frac 58.
\]

It remains to note that the assumption $|A_1| = |A_2| = |B_1| = |B_2| = \frac{n-1}{4}$ does not increase the distance between $T$ and $R$.
Indeed, the sets can be chosen so that at most half of the nodes have to cross the root, that is, $|A_2 \cup B_1| \le \frac{n-1}{2}$.
Furthermore, the smaller the size of $A_2 \cup B_1$ the shorter the path.
Finally, the total length of the path is maximized when $|A_2| = |B_1|$ and $|A_1| = |B_2|$.
\todo[inline]{AG: A detailed proof includes a check of all 10 steps.
Do we need that in the text? CW: I don't think a detailed check of all the steps is necessary and it would certainly have to be supplemental material. However, I do think you need more here. A figure would make this easier to follow.}
\endproof

\begin{corollary}\label{diameterUpperBoundCoro}
$\Delta(\rnniu) < n^2 - n$ for all $n$.
\end{corollary}


\subsection{Split theorem}

\textcite{li1996some} used the information about the diameter of the space and the sizes of neighborhoods to provide an example of trees such that every shortest $\nni$ path between the trees fails to maintain a split of taxa shared by the origin and destination trees.~\todo{You should mention the history of the problem either here or in the introduction (assuming we can prove the theorem).}
Specifically, they showed that sorting two caterpillar trees simultaneously is more efficient than sorting them independently, provided the size of the trees is large enough.
In the following lemma, we show that the ranked versions of $\nni$ space maintain splits along shortest paths between caterpillar trees.

\begin{theorem}\label{splitTheo}
 Every split present in both trees $T$ and $R$ presents in all trees along every shortest path between $T$ and $R$ in $\dtt$, $\dttu$, $\rnni$, and $\rnniu$, but not in $\nni$.
 \end{theorem}

\proof
The work-in-progress proof is on branch
\url{https://github.com/gavruskin/curvatureNNI/tree/splitTheoProof} branch.

Let $A|B$ be the split under considertaion and $T_A$, $T_B$, $R_A$, $R_B$---corresponding restriction of trees $T$ and $R$.
The arguments goes as follows.
Assume the contrary: there exists a geodesic that does not maintain the split.
This path hence should first mix trees $T_A$ and $T_B$ together into a tree $T_A \oplus T_B$.
Then convert $T_A \oplus T_B$ into $R_A \oplus R_B$ and then separate the latter tree into $R_A$ and $R_B$.
The main ingradient of the proof is that mixing $T_A$ and $T_B$ together and then separating them into $R_A$ and $R_B$ takes more steps than just convert $T_A$ into $R_A$.
Assuming $T_A$ and $R_A$ are of size $\frac n2$, it is enough to show that mixing + separating takes strictly more steps than the diameter of $\rnniu$ on $\frac n2$ taxa trees.

The scenario works fine for many partial cases, e.g.\ double-caterpillar trees.
The general case remain illusive.
\endproof


\subsection{Computing the distance}

We first bound the number of neighbors of a tree $x$ in $\dts$-space that are closer than $x$ to a given tree $y$.
We show that the maximum fraction of neighbors that tend closer to $y$ grows linearly with respect to $d(x,y)$.
These subsets of neighbors are the force pushing towards positive curvature, so this will allow us to bound the maximum curvature with respect to distance.~\todo{curvature is mentioned here. This probably needs to be rewritten.}

\begin{theorem}
\label{max_good_neighbours}
Let $x$ and $y$ be two trees.
Then the number of trees $u \in N(x)$ such that $d(u, y) \le d(x, y)$ is at most
\begin{enumerate}[(i)]
\item $2d(x,y)$ in $\nni$ space,
\item $3d(x,y)$ in $\rnni$ space,
\item $4d(x,y)$ in $\dts$ space,
\todo{How is this consistent with the $8$ in Lemma~\ref{uniformLower}?}
\item $5d(x,y)$ in $\dtt$ space.
\end{enumerate}
\end{theorem}

\begin{proof}
We first prove the statement for $\dts$ space.

Let $U$ be the set of neighbors $u$ of $x$ such that $d(u,y) \le d(x,y)$, as stated in the theorem.
We partition $U$ into three sets of trees---$I$, $R$, and $L$---obtained from $x$ by a single NNI move, rank change, or length change, respectively.
We then prove the theorem by bounding the size of each partition by $2d(x,y)$, $d(x,y)$, and $d(x,y)$, respectively.

We first consider some basic properties of minimal length paths between $x$ and $y$.
Observe that at most $d(x,y)$ bipartitions differ between $x$ and $y$, as each NNI operation replaces one bipartition with another (and rank and length changes do not modify bipartitions).
Now, observe that no minimal length path from $x$ to $y$ will replace a bipartition that is common to $x$ and $y$, as any path including such a replacement can be made shorter by removing the replacement move (and subsequent moves that reintroduce the bipartition).

We are now ready to bound the sizes of each partition $I$, $R$, and $L$.
First, consider the subset $I$ of closer neighbors obtained via NNI moves.
By our observations above, $|I|$ is bounded by the number of NNI operations that modify one of the at most $d(x,y)$ bipartitions of $x$ that are not a bipartition of $y$.
There are two neighbors of $x$ that lack any given bipartition (obtained by moving either the left or right subtree located below the bipartition).
Therefore, $|I| \le 2d(x,y)$.

Second, consider the subset $R$ of closer neighbors obtained via rank change moves.
These operate either on one of $x$'s unique bipartitions or a bipartition common to $x$ and $y$ that differs in rank.
As observed above, the number of unique bipartitions is bounded by the maximum number of NNI moves on any minimal $x$ to $y$ path.
Any such path must fix the ranks of each common edge.
In other words, if $r_1$ is the number of trees in $U$ which are obtained from $x$ by a rank move corresponding to a common edge and $r_2$ is the number of trees in $U$ which are obtained from $x$ by a rank move corresponding to a unique edge of $x$, then $r_1 + r_2 \leq d(x,y)$, because the $r_1$ moves have to be done along every shortest path from $x$ to $y$.
Thus, the total size of $R$ is bounded by $d(x,y)$.

The bound of $d(x,y)$ on the number of length changes that can be applied to move $x$ closer to $y$ follows similarly.
Therefore, there are at most $|I| + |R| + |L| \le 2d(x,y) + d(x,y) + d(x,y) = 4d(x,y)$ trees $u \in N(x)$ such that $d(u, y) \le d(x, y)$.

The statement for the other three spaces follows similarly: for $\nni$ we need to count only for trees from $I$, for $\rnni$ we need to count only for trees from $I$ and $R$, for $\dtt$ we will have to add $2d(x,y)$ instead of $d(x,y)$ for $L$.
\end{proof}

A non-ranked tree has a symmetry associated with every internal node.
Those symmetries can be employed to substantially reduce the search space of pairs of trees.
This approach uses tanglegrams \autocite{Matsen2015-fn} and is applied to reduce the number of pairs of tree for computing the curvature \autocite{Whidden2015-es}.
As the following proposition shows, ranked trees are free from all but one of those symmetries, hence the tanglegram approach is not applicable in this case.

\begin{proposition}
Let $T$ be a tree from $\dtt$, $\dttu$, $\rnni$, or $\rnniu$ and $\sigma$ a permutation of taxa of $T$.
Let $T_\sigma$ be the tree obtained from $T$ by permuting the taxa using $\sigma$.
Then $T = T_\sigma$ if and only if $\sigma$ is either the identity permutation or a transposition of a pair of taxa that form a
cherry\footnote{A \emph{cherry} is a pair of taxa adjacent to a common internal node in the tree.}
in $T$.
\end{proposition}

\proof
The sufficiency is obvious.
For the necessity, assume that $\sigma$ transpose taxa $i,j$ such that $i,j$ is not a cherry in $T$.
This implies that $i$ and $j$ have different parents.
Hence $T \ne T_\sigma$ because the ranks of the parent of $i$ are different in $T$ and $T_\sigma$.
\endproof

These observations suggest that $\nni$ space is geometrically and algorithmically different from the other four spaces.


\iftoggle{curvatureON}{
\section{Ricci-Ollivier curvature of discrete time-trees}

We need the following corollaries for our analysis of curvature.

\begin{corollary}\label{degreeBounds}
The following are satisfied in $\dtt$ space for every pair of trees $T$ and $R$.
\begin{align*}
& \deg(T)-\deg(R) \leq 3n-4		&& \mbox{in $\dtt$ space,}\\
& \deg(T)-\deg(R) \leq 2n-4		&& \mbox{in $\dttu$ space,}\\
& \deg(T)-\deg(R) \leq 2n-3		&& \mbox{in $\rnni$ space,}\\
& \deg(T)-\deg(R) \leq n-3			&& \mbox{in $\rnniu$ space,}\\
& \dfrac25 < \dfrac{\deg(T)}{\deg(R)} < \dfrac52		&& \mbox{in $\dtt$ space,}\\
& \dfrac13 < \dfrac{\deg(T)}{\deg(R)} < 3			&& \mbox{in $\dttu$ and $\rnni$ spaces,}\\
& \dfrac12 < \dfrac{\deg(T)}{\deg(R)} < 2			&& \mbox{in $\rnniu$ space,}\\
\end{align*}
and all inequalities are tight.
\end{corollary}

\proof
The first four inequalities follow from Lemma~\ref{neighBound} immediately.

For the fifth inequality we note that
\[
\frac{\deg(T)}{deg(R)} \geq \frac{2(n-1)}{5n-6} = \frac25 \left(1 + \frac{1}{5n-6}\right) \searrow \frac 25 \mbox{ when } n\to\infty
\]
The upper bound follows similarly, as well as the rest of inequalities.
\endproof

For $\nni$ space, Lemma~\ref{neighBound} implies that $deg(T)-deg(R) = 0$ and $\frac{\deg(T)}{deg(R)} = 1$.

Let $N(T)$ be the set of trees at distance one from $T$, that is, the set of trees adjacent to $T$ in the corresponding graph.
The following lemma describes how many trees the tree neighborhoods can have in common.

\begin{lemma}\label{intersecNeighb}
The following is true for all the spaces $\nni$, $\rnni$, $\rnniu$, $\dtt$, and $\dttu$.
If $d(T,R) = 1$ then $|N(T)\cap N(R)|\in\{0,1\}$.
\end{lemma}

\proof
Suppose $T$ and $R$ are neighbors.
If the trees differ by a single branch length or rank change then the fact that NNI moves only apply to short branches implies that any shared neighbor $S$ would have to match the length or rank of one of the trees.
As $S$ must differ from both trees, they do not have a neighbor in common.
If $T$ and $R$ are NNI-neighbors, there is precisely one tree which is a neighbor of both $T$ and $R$, namely the third tree that can be obtained by resolving the interval that connects $T$ and $R$.
\endproof

The following general lemma is true for all graphs, particularly, for those we consider in this paper.
By \emph{distance-one random walk}, we mean a random walk $(m_x)_{x \in X}$ satisfying $m_x(y) = 0$ for all $x$ and $y$ such that $d(x,y) > 1$.

\begin{lemma}\label{curvBoundGeneral}
Let $(M,d)$ be a finite metric space and $x,y$ a pair of points from $M$.
If $(m_x)_{x \in M}$ is a distance-one random walk on $M$, then the curvature $\kappa$ of the random walk satisfies the following boundary conditions.
\[
\dfrac{-2}{d(x,y)} \leq \kappa(x,y) \leq \dfrac{2}{d(x,y)}.
\]
\end{lemma}

\proof
Let $x$, $y$, $u$, and $v$ be arbitrary points from $M$ such that both $m_x(u)$ and $m_y(v)$ are positive.
Since $m$ is a distance-one random walk, $d(u,v) \leq d(x,y) + 2$.
Hence for any coupling $\{p_{u,v}\}$,
\[
W(m_x,m_y) \leq \sum p_{u,v} d(u,v) \leq (d(x,y)+2)\sum p_{u,v} = d(x,y) + 2,
\]
where the sum is taken over a correspondence between the set of $u \in N(x)$ and $v \in N(y)$.
So, $\kappa(x,y) \geq - 2/d(x,y)$.
The lower bound follows similarly from $d(u,v) \geq d(x,y) - 2$.
\endproof

Note that this lemma can be generalized to \emph{distance-$d$} random walks, which are those satisfying $m_x(y) = 0$ for all $x$ and $y$ such that $d(x,y) > d$.
In this case, using the notations of the lemma, $d(u,v) \leq d(x,y) + 2d$.
Thus,
\[
-\dfrac{2d}{d(x,y)} \leq \kappa(x,y) \leq \dfrac{2d}{d(x,y)}.
\]

As we will see in the next few lemmas, these bounds can be improved for certain random walks on the graphs under consideration.

\begin{lemma}\label{uniformUpper}
Let $T$ and $R$ be adjacent trees.
Then the curvature of the following spaces with uniform random walk satisfy
\begin{align*}
& \kappa(T,R) \leq \dfrac{1}{2(n-1)}	&& \mbox{for $\dtt$ space,}\\
& \kappa(T,R) \leq \dfrac{1}{2(n-2)}	&& \mbox{for $\nni$ space, and}\\
& \kappa(T,R) \leq \dfrac{1}{n-1}	&& \mbox{for $\rnni$, $\rnniu$, and $\dttu$ spaces.}
\end{align*}
The bounds are tight.
\end{lemma}

\proof
To maximize the curvature $\kappa(T,R)$, we have to minimize $W(m_T,m_R) = \inf\limits_{\mu\in\M} \sum\limits_{x,y\in V}\mu(x,y) d(x,y)$.
The latter is minimized when the probability mass $\mu(x,y)$ to be moved at shorter distance $d(x,y)$ is maximized.
Since $d(T,R) = 1$, it follows from Lemma~\ref{intersecNeighb} that the smallest possible value of $d(x,y)$ is $0$ (the case when $|N(T) \cap N(R)| = 1$).
Hence, to maximize the curvature we are to maximize the probability mass allocated to the tree $E$ in the intersection $N(T) \cap N(R)$.
It follows from Lemma~\ref{neighBound} that the maximal mass $p_E$ we can allocate under a uniform random walk to the tree $E$ is $\frac{1}{2(n-1)}$ in $\dtt$ space, $\frac{1}{2(n-2)}$ in $\nni$ space, and $\frac{1}{n-1}$ in $\rnni$, $\rnniu$, and $\dttu$ spaces.
It is not hard to see that trees $T$ and $R$ can be chosen so that $d(x,y) = 1$ for all $x,y$ which are different from $E$ and for which $\mu(x,y) > 0$.
Hence, $\kappa(T, R) = 1 - \left(\sum\limits_{x,y\in V\setminus\{E\}}\mu(x,y)\cdot 1 + p_E \cdot 0\right) = 1 - (1-p_E) = p_E$.
The lemma follows.
\endproof

This lemma and corollary provide tighter upper bounds for the curvature than Lemma~\ref{curvBoundGeneral} for all $n$.

It is easy to generalize the lemma to the uniform $p$-lazy random walk.
Indeed, we observe that the curvature between adjacent trees $T$ and $R$ under a uniform $p$-lazy random walk satisfies
\begin{align*}
& \kappa(T,R) \leq \frac{p}{2(n-1)}	&& \mbox{in $\dtt$ space,}\\
& \kappa(T,R) \leq \frac{p}{2(n-2)}	&& \mbox{in $\nni$ space, and}\\
& \kappa(T,R) \leq \frac{p}{n-1}		&& \mbox{in $\rnni$, $\rnniu$, and $\dttu$ spaces.}
\end{align*}

We recall that the \emph{asymptotic Ricci-Ollivier curvature}~\autocite{Loisel2014-gu} $\ric$ of a metric space with uniform $p$-lazy random walk is defined by
\[
\ric(x,y) = \lim_{p\to0} \frac{\kappa(x,y)}{p}
\]

In this case the asymptotic curvature between adjacent trees in $\dtt$ with uniform $p$-lazy random walk is bounded from above by
\[
\frac{1}{2(n-1)}
\]

Following \textcite{Loisel2014-gu}, we will refer to non-asymptotic curvature as \emph{coarse curvature} to distinguish between the two alternative notions of curvature.


Thus, the upper bounds of asymptotic curvatures of $\nni$, $\rnni$, $\rnniu$, $\dtt$, and $\dttu$ spaces coincides with the coarse curvatures of the spaces.

We continue with lower bounds on curvature of spaces with uniform lazy random walks.

\begin{lemma}\label{uniformLower}
Let $T$ and $R$ be adjacent trees.
Then both the asymptotic curvature of the space with $p$-lazy uniform random walk and the curvature of the space with uniform random walk are at least
\begin{enumerate}[(i)]
\item $-\dfrac{4}{n-1}$ in $\dtt$ space,
\item $-\dfrac{4}{n-2}$ in $\nni$ space,
\item $-\dfrac{8}{n-1}$ in $\rnni$ space.
\end{enumerate}

The bounds are tight.
\end{lemma}

\proof
Let $T$ and $R$ be two adjacent trees.
To minimize the curvature, we have to maximize $W(m_T, m_R)$ across $T$ and $R$.
The latter is maximized when the probability mass on trees $E\in N(T)$ such that $d(E, N(R)) > d(T, R)$, is
maximized\footnote{If $x$ is a point of a metric space $(M,d)$ and $S \subseteq M$ then by $d(x,S)$ we denote $\inf\limits_{s \in S} d(x,s)$.}.
Since $d(T, R) = 1$, the maximum possible number of such trees $E$ is
\todo{Explain this.
EM skipped pending explanation.}
$8$.
To make $W(m_T,m_R)$ being as large as possible, we have to assume $d(S, N(R)) = 1$ for the rest of the trees $S$ from $N(T)$.
Hence for the uniform random walk we have:
\[
W(m_T,m_R)\leq 8 \cdot 2 \cdot \frac{1}{|N(T)|} +
(|N(T)| - 8) \cdot \frac{1}{N(T)} = 1 + \dfrac{8}{|N(T)|}.
\]
Hence, $\kappa(T,R) = 1 - W(m_T,m_R) \geq - \dfrac{8}{|N(T)|}$.

A similar reasoning applies for the $p$-lazy random walk:
\[
W(m_T,m_R)\leq 8 \cdot 2 \cdot \frac{p}{|N(T)|} +
(|N(T)| - 7) \cdot \frac{p}{|N(T)|} + (1-p) - \frac{p}{|N(T)|} =
\]
$1 + \dfrac{8p}{|N(T)|}$.
Hence, $\ric(T,R) = \lim\limits_{p\to0}\left(1 - W(m_T,m_R)\right) \geq - \dfrac{8}{|N(T)|}$.

It remains to note that Lemma~\ref{neighBound} gives us an estimate $|N(T)| \geq 2(n-1)$ in $\dtt$, $|N(T)| \geq 2(n-2)$ in $\nni$, and $|N(T)| \geq n-1$ in $\rnni$ space.
The lemma follows.
\endproof

\begin{corollary}\label{flatInLimDTS}
Let $(T_n,R_n)_{n\in\omega}$ be a sequence of pairs of trees such that $d(T_n,R_n) = 1$ in $\nni$, $\rnni$, or $\dtt$ space.
Then $\lim\limits_{n \to \infty}\kappa(T_n,R_n) = \lim\limits_{n \to \infty}\ric(T_n,R_n) = 0$.
\end{corollary}

\proof
Follows from Lemma~\ref{uniformUpper} and Lemma~\ref{uniformLower}.
\endproof

As we have just proved, the corollary above holds true in $\nni$, $\rnni$, and $\dtt$ spaces.
This corollary is also true in the SPR space of rooted trees \autocite{Whidden2015-es}.
Actually, this property can be derived from the following general statement for all spaces mentioned, as well as for many others.

\begin{proposition}\label{flatInLimGen}
Let $(M_n,d_n)_{n \in \omega}$ be a sequence of finite metric spaces and $(x_n, y_n)$ a sequence of adjacent vertices from $M_n$, that is $d_n(x_n,y_n) = 1$, such that
\begin{enumerate}[(1)]
\item\label{intersec} $\big|N(x_n) \cap N(y_n)\big| = o(|N(x_n)|)$
\item\label{difference} $\big||N(x_n)| - |N(y_n)|\big| = o(|N(x_n)|)$
\item\label{dist2} $\big|\{(x,y) \mid
	x \in N(x_n),~ y \in N(y_n),~ d(x, y) \geq 2\}\big| = o(|N(x_n)|)$
\end{enumerate}

Then $\lim\limits_{n \to \infty} \kappa(x_n, y_n) = 0$.
\end{proposition}

\proof
Consider an arbitrary $n$ and the pair of points $x_n,y_n$.
Set $I_0 = N(x_n) \cap N(y_n)$, denote by $I_1$ the set of points $z$ such that the probability mass is moved from $z$ at distance one under the optimum coupling for $W(m_{x_n},m_{y_n})$, by $I_2$ the set of points $z$ such that the probability mass is moved from $z$ a distance $\geq 2$ under the optimum scenario for $W(m_x,m_y)$.
Then
\[
W(m_{x_n},m_{y_n}) = \sum_{I_0} d_i x_i p_{x_i} + \sum_{I_1} d_i x_i p_{x_i} +
\sum_{I_2} d_i x_i p_{x_i}.
\]
It follows from~(\ref{intersec}) and~(\ref{dist2}) that the first and the last sums are $\O(1)$ when $n\to\infty$.
This together with property~(\ref{difference}) implies that the middle sum tends to $1$ when $n\to\infty$ because the number of points $z$ such that the probability mass has to travel at distance one under an optimum scenario, divided by $|N(x_n)|$, tends to $1$ when $n\to\infty$.
\endproof

We note that in both Corollary~\ref{flatInLimDTS} and Proposition~\ref{flatInLimGen}, the assumption of being at distance one can be relaxed by that of being at a distance uniformly bounded by a slowly growing function.
But since the primary focus of this paper is on the spaces under consideration, we will not \todo{Should we?} include the statement in general terms of metric spaces.
However, we prove below (Theorem~\ref{zero-in-the-limit}) a much stronger property of the spaces, namely, that the curvature tends to zero when the tree size tends to infinity does not matter what distance between the trees is.
}
{}

\iftoggle{curvatureON}{
We now use Theorem~\ref{max_good_neighbours} to prove the following.

\todo[inline]{$\downarrow$ This must be true for $p$-lazy walk as well.}

\begin{theorem}\label{zero-in-the-limit}
Let $(T_n,R_n)_{n\in\omega}$ be a sequence of pairs of $\dts$-trees on $n$ taxa.
Then $\lim\limits_{n \to \infty}\kappa(T_n,R_n) = 0$ for the uniform random walk.
\end{theorem}

\proof
Since the curvature is a local property, it follows from Lemma~\ref{uniformLower} that $\kappa(T_n,R_n) \geq -\dfrac{4}{n-1}$ for all $n$.
To finish the proof, we need to bound the sequence $\kappa(T_n,R_n)$ from above by another sequence which tends to zero.

Let us fix an $n$ and let $U$ be the set of trees $E \in N(T)$ such that $d_\dts(E,R_n) \leq d_\dts(T_n,R_n)$ as in Theorem~\ref{max_good_neighbours}, and $B$ be the rest of trees $N(T_n)\setminus U$ from $N(T_n)$.
Let's denote $d_\dts(T_n,R_n)$ by $d$.
Then
\[
W(m_{T_n},m_{R_n}) = \sum_{i\in U} p_i d_i + \sum_{j\in B} p_j d_j \geq
\sum_{i\in U} p_i (d-2) + \sum_{j\in B} p_j d =
\frac{|U|(d-2)}{|N(T_n)|} + \frac{|B|d}{|N(T_n)|}.
\]
Hence,
\[
\kappa(T_n,R_n) = 1 - \frac{W(m_{T_n},m_{R_n})}{d} \leq
1 - \frac{|U| + |B|}{|N(T_n)|} + \frac{2|U|}{|N(T_n)|d}
= \frac{2|U|}{|N(T_n)|d}.
\]
It follows from Theorem~\ref{max_good_neighbours} that $|U| \leq 4d$.
Thus, $\kappa(T_n,R_n) \leq \dfrac{8}{|N(T_n)|}$.
It remains to note that $\lim\limits_{n\to\infty}\dfrac{8}{|N(T_n)|} = 0$.
\endproof

Clearly, the same reasoning goes through for the other three spaces under consideration:

\begin{corollary}
Let $(T_n,R_n)_{n\in\omega}$ be a sequence of pairs of trees on $n$ taxa.
Then $\lim\limits_{n \to \infty}\kappa(T_n,R_n) = 0$ for $\nni$, $\rnni$, and $\dtt$ distances.
\end{corollary}

We now estimate the curvature of the Metropolis-Hastings random walk, which proposes a tree in the one-neighborhood uniformly at random and accepts the proposal with probability $\min\left(1, \dfrac{|N(T_{old})|}{|N(T_{new})|}\right)$.
We denote the corresponding curvature by $\kappa(\MH;T,R)$.

\begin{lemma}
The following inequalities are satisfied in both $\dts$ and $\dtt$ spaces.
\[
\kappa(T,R) - \dfrac{6}{5d(T,R)} \leq \kappa(\MH;T,R) \leq \kappa(T,R) +
\dfrac{6}{5d(T,R)}\mbox{, and}
\]
\[
\kappa(T,R) - \dfrac35 \leq \kappa(\MH;T,R) \leq \kappa(T,R) + \dfrac35.
\]
\end{lemma}

\proof
From Corollary~\ref{degreeBounds} we have that $\frac{|N(T_{old})|}{|N(T_{new})|} \geq \frac{2}{5}$, so the probability mass that an MH move leaves at $T_{old}$ is not greater than $\frac35$.
The rest of the proof follows \autocite[][Proof of Lemma~V.8]{Whidden2015-es} literally.
\endproof

\begin{corollary}
The following inequalities are satisfied in $\rnni$ \todo{What about NNI?} space.
\[
\kappa(T,R) - \dfrac{4}{3d(T,R)} \leq \kappa(\MH;T,R) \leq \kappa(T,R) +
\dfrac{4}{3d(T,R)}\mbox{, and}
\]
\[
\kappa(T,R) - \dfrac23 \leq \kappa(\MH;T,R) \leq \kappa(T,R) + \dfrac23.
\]
\end{corollary}

\proof
Use Corollary~\ref{degreeBounds}.
\endproof
}{}


\subsection{Efficient algorithm for generating $\rnni$ graphs}

We use the following algorithm designed by \textcite{Whidden2015-es} to compute the $\rnni$ graph on $n$ leaves.
The input to our algorithm is a set $S$ of ranked phylogenetic tree topologies in the format described by \textcite{Gavryushkin2014-bw} \autocite[see also][]{Semple2003-nj}.
A tree is hence given by a sequence of sets of taxa, and thus obtained representation is unique.
For example, the representation of the tree on Figure~?? \todo{} is $(\{A\}, \{C\}, \{D\}, \{B\}, \{E\}, \{A,B\}, \{D,E\}, \{C, D, E\}, \{F\}, \{A,B,F\}, \{A,B,C,D,E,F\})$, or
$(\{A,B\}, \{D,E\}, \{C, D, E\}, \{A,B,F\}, \{A,B,C,D,E,F\})$ if we make the tree ultrametric by placing all taxa below the most recent divergence event.
Using this representation of trees we construct a map $\nu : S \to \omega$, where $\omega$ is the set of non-negative integers.
This maps allows us to determine whether or not a tree is already a vertex of the graph.

The high-level steps of the algorithm follow \textcite{Whidden2015-es} literally, as well as the proof of correctness of the algorithm.

\textsc{Construct-$\rnni$-Graph($S$)}
\begin{enumerate}[1.]
	\item Let $G$ be an empty graph.
	\item Let $\nu$ be an empty mapping from trees to integers.
	\item Let $i = 0$.
	\item For each of the $m$ trees: \vspace{-0.2em}
		\begin{enumerate}
			\item Add a vertex $i$ to $G$ representing the current tree $T_i$.
			\item Add $T_i \rightarrow i$ to $\nu$.
			\item For each neighbor $T_j$ of $T_i$:
				\begin{enumerate}
					\item[(j)] If $T_j$ is in $\dom(\nu)$ then add an edge $(i, \nu(T_j))$ to $G$.
				\end{enumerate}
		\item $i = i + 1$.
		\end{enumerate}
\end{enumerate}

We implemented this procedure for ultrametric trees in the Python program \texttt{tau\_graph}
\todo{Check the name.}
of the software package \texttt{tTauCurvature} \autocite{tTauCurvature},
\todo{Get DOI for Github.}
which outputs an edge list format graph suitable for input to other software.


\iftoggle{curvatureON}{
\section{Some other spaces}

Several important proposal mechanisms used in phylogenetic Bayesian inference by popular software packages such as BEAST2 \autocite{beast2} favor topological moves or tree moves depending on various conditions.
All tree moves we have been considering so far do not make an explicit distinction between topological changes and branch length changes.
To address this issue\todo{issue?}, we consider the following tree move that explicitly allows distributing the acceptance probability between topological and branch length moves.

{\bf Lazy walk.}
Let $p$ be the laziness probability, that is, we do nothing with probability $1-p$ and distribute the probability $p$ as follows.
We decide first on what type of move we want to perform: choose a topological move with probability $q$ and a length move otherwise, that is, $q \leq p$ and the probability of a length move is $p-q$.
The proposal is rejected if a topological move is impossible.

{\bf tau move.}
Choose a coordinate uniformly at random.
Increase the coordinate by $1$ with probability $p$ and decrease it by $1$ otherwise.
If the coordinate becomes $0$, resolve the multifurcation uniformly at random and set the new coordinate to $1$.
Note that this mechanism does not bound edge lengths from above and favors topological moves when $p<1/2$.
}{}


\vskip10pt
\todo[inline]{Conjectures won't go to the journal.}
\subsection{Conjectures}
\begin{conjecture}
\begin{enumerate}[(1)]
The list of conjectures that would be nice to settle or refute in this paper:
\item Theorem~\ref{splitTheo}.
\item $d_\rnniu$ is polynomial.
\item Proposition~\ref{isoperiPropo}.
\end{enumerate}
\end{conjecture}

We finish this section with the following proposition that suggests that the graphs under consideration have ``bottlenecks''.
To make this statement precise we need to introduce the following notion.
Let $G = (V, E)$ be an undirected graph and $S$ a subset of the set of vertices $V$.
The boundary $\partial S$ of $S$ is the set of edges ``pointing our from $S$'': $\partial S = \{(v,w) \in E \mid v \in S ~\&~ w \notin S\}$.
Then the \emph{isoperimetric number} $h(G)$ of $G$ is defined by
\[
h(G) = \inf\limits_{0 < |S| \leq \frac12|V|} \frac{|\partial S|}{|S|}.
\]

\begin{proposition}\label{isoperiPropo}
Let $G_n$ be $\dtt$, $\dttu$, $\rnni$, $\rnniu$, or $\nni$ graph on trees with $n$ taxa.
Then $\lim_n h(G_n) = 0$.
\end{proposition}

\proof
We assume that the taxa set is $\{1,\ldots,n\}$ and denote the set $\{1,\ldots,\lfloor \frac n2 \rfloor\} \leftrightharpoons A$ and $\{\lfloor \frac n2 \rfloor + 1,\ldots, n\} \leftrightharpoons B$.
Let $S$ be the set of trees $T$ such that $T$ has the split $A \mid B$.
Then $\lim_n \frac{|\partial S|}{|S|} = 0$ for all graphs under consideration.
\endproof

This proposition implies for phylogenetic graphs that the isoperimetric number is asymptotically the smallest possible, which can be interpreted as that the graphs have as the tightest possible bottlenecks.


\section{Discussion}
Most of the results in this paper can be generalized to the class of sampled ancestor trees \autocite{Gavryushkina2014-xd}.
However, currently very few methods of sampling the space of sampled ancestor trees are known \autocite{Gavryushkina2015-vq} and the geometry of the space is poorly understood \autocite{Gavryushkin2014-bw}.


\printbibliography

\end{document}

