\documentclass{amsart}

\synctex=1

\usepackage{amsmath,amsthm}
\usepackage{todonotes}
\usepackage[notref,notcite]{showkeys} % show keys for eqs, etc.
%\usepackage{cite}
\usepackage{enumerate}
\usepackage{url}
\usepackage[colorlinks=true]{hyperref}
\usepackage{natbib}

\newtheorem{lemma}{Lemma}
\newtheorem{question}{Question}
\newtheorem{proposition}{Proposition}

\newcommand{\tN}{\mathrm{\tau NNI}}
\newcommand{\dts}{\mathrm{DTS}}

\begin{document}

\section{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this paper we study the curvature of Markov chains over phylogenetic trees. 
We see different spaces of phylogenetic trees as graphs where the adjacency 
relation is given by a tree move. Those graphs can be also seen as metric 
spaces where the distance between two points is given by the length of a
shortest path connecting them. All graphs we are considering in this paper are
connected, so thus defined distance is a metric indeed. 

A Markov chain (often a random walk in our case) is defined on a graph by its
proposal mechanism, which is a functional $m$ that maps vertices of the graph to
the set of measures on this graph. In other words, for every vertex $v$, 
$m_v(w)$ is the (probability) of getting from $v$ to $w$ in one step. 

We consider a number of Markov chains that arise 
\todo{Do they?} 
in phylogenetic Bayesian 
inference and investigate the curvature of those chains with an eye towards 
the efficiency properties of the corresponding inference methods. 

\section{Discrete time-tree space}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

In this section we introduce a discrete analogue of the space of time-trees
and establish several graph-theoretic properties of this space, which will
be useful in later section for the study of the curvature of certain random
walks on the space. 

The easiest way to define the space is to assume that the reader is familiar 
with~\cite{Gavryushkin2014-bw} and say that the 
{\em discrete time-tree space,}
or $\dts$ for short, is the $\mathrm t$-space defined 
in~\cite{Gavryushkin2014-bw}, where the
branch lengths are allowed to take only three values, $0$, $1$, and $2$. 
In other words, to define a tree in the $\dts$, we first fix a ranked tree 
topology with all nodes being of different ranks and then assign a number
from $\{1,2\}$ to every intercoalescent interval. Intuitively, we will have
only two options for the length of an intercoalescent interval, which can
be thought of as short 
\todo{I'm fairly certain that all we are going to say about this space can
be generalised to $n$ intercoalescent interval lengths.}
and long. 
We shall address to the numbers assigned to the coalescent intervals as to
the {\em lengths} of those intervals. 

Two trees from $\dts$ are adjacent if and only if precisely one of the following
conditions is satisfied: 

\begin{enumerate}[(1)]
\item The trees have identical ranked topologies and there exists a unique
intercoalescent interval such that its length in one tree is smaller than in the
other by one unit. 
\item The trees have identical topologies, there exists a unique pair of nodes
which have different rank in the two trees, and the intercoalescent intervals 
between these two nodes are of the smallest possible length in both trees. 
\item The trees have topologies which differ by one NNI move, all nodes that
are not involved in the NNI move have identical ranks, all intercoalescent
intervals that are not involved in the NNI move have identical lengths, 
and the two intervals that are involved in the NNI move (the one that was there
before the move and the one that appeared after the move) both have the minimal
possible length.  
\end{enumerate}

In other words, by going from one tree to an adjacent tree in the graph we can
either change the length of one intercoalescent interval by one unit or we
can send an intercoalescent interval of minimal length down to zero and
then resolve the multifurcation to either of the two possible topologies
(one possible topology if there is no multifurcation) and
assign the minimal length to the new interval.

Thus, we will interchangeable refer to $\dts$ as a graph or a metric space. 
We will denote the corresponding distance by $d_\dts$. 

\begin{lemma}
Let $T$ be a $\dts$-tree on $n>2$ leaves. Then \[2n-1\leq \deg(T)\leq3n-4\] 
\end{lemma}

\proof
Obvious. 
\endproof

\begin{lemma} The following are satisfied. 
\begin{enumerate}[(1)]
\item $deg(T)-deg(R) \leq n-3.$
\item $\dfrac{\deg(T)}{deg(R)}>\dfrac23.$
\item $\liminf\limits_n\dfrac{\deg(T)}{deg(R)}=\dfrac23.$
\end{enumerate}
\end{lemma}

\proof
Follows from previous Lemma. 
\endproof

\begin{lemma}
$d_{\dts}(T,R) = 1 \Rightarrow |N_1(T)\cap N_1(R)|\in\{0,1\}.$
\end{lemma}

\proof
Obvious.
\endproof

\begin{lemma}
Under a distance-one random walk, the following is true for any finite 
metric $d$ and any pair of points $x,y$:
\[
\dfrac{-2}{d(x,y)} \leq \kappa(x,y) \leq \dfrac{2}{d(x,y)}.
\]
\end{lemma}

\proof
Obvious, assuming the measure of any point is bounded by one. 
\endproof

\begin{lemma}
The curvature of a uniform random walk on the discrete $\tau$-space satisfies 
\[
\kappa_{d\tau}(T,R) \leq 
\dfrac{1}{2(n-2)}.
\]
\end{lemma}

\proof
Follows from Lemma~5.2 in~\cite{Whidden2015-es}. 
\endproof

What does this Lemma say about full and topological $\tau$-spaces? 
In full $\tau$-space, $\kappa(T,R) \leq 0$~\cite{Gavryushkin2014-bw} for some random walk. 
For which one? 

\begin{lemma}
\begin{enumerate}
\item The curvature of the $p$-lazy uniform random walk on the, the NNI
graph, the $\tau$-graph, and the discrete $\tau$-space on rooted trees with 
$n$ leaves is bounded from below by $-\displaystyle\frac{3p}{n-2}.$
\item Subtract $2/3$ to get a lower bound on the curvature of the
uniform prior Metropolis-Hastings random walk.
\end{enumerate}
\end{lemma}

\proof
(1) Let $T$ and $S$ be two NNI-adjacent trees. There are at most $8$ unpairable 
trees in $N_1(T)$ and one tree in the intersection $N_1(T) \cap N_1(S)$. The
total number of elements of $N_1(T)$ is $2(n-2).$
Hence, 
\[
W_1(m_T,m_S)\leq (1 - p - \frac{p}{2(n - 2)}) + 
8 \cdot 2 \cdot \frac{p}{2(n - 2)} +
(2(n - 2) - 9)\frac{p}{2(n-2)} =
\]
$1 + \displaystyle\frac{3p}{n-2}.$ 
Hence, $1 - W_1(m_T,m_S) \leq - \displaystyle\frac{3p}{n-2}.$

(2) Same reasoning as in~\cite{Whidden2015-es}. 
\endproof

\begin{proposition}
Let $(\mathcal G_n)_{n \in \omega}$ be a sequence of finite graphs and 
$(x_n, y_n)$ a sequence of adjacent vertices from $\mathcal G_n$ such that
\begin{enumerate}[(1)]
\item $\big|N(x_n) \cap N(y_n)\big| = o(|N(x_n)|).$ 
\item $\big||N(x_n)| - |N(y_n)|\big| = o(|N(x_n)|).$ 
\item $\big|\{(x,y) \mid x \in N(x_n),~ y \in N(y_n),~ d(x, y) \geq 2\}\big| 
= o(|N(x_n)|).$
\end{enumerate}

Then $\lim\limits_{n \to \infty} \kappa(x_n, y_n) = 0.$
\end{proposition}

\proof

\endproof

\begin{question}
Assume some (e.g.\ uniform, lazy, ...) random walk. What are the $m$ and $M$ 
such that 
\[
m(\deg x,\deg y, \ldots) \leq \kappa(x,y) \leq M(\deg x, \deg y, \ldots)? 
\]
\end{question}

\section{Some other space}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We now extend the space of possible moves by including branch length moves. 
In general, such moves should allow the branch length to be any positive real 
number, but this setting seems to require quite sophisticated techniques for 
computing the curvature and hence is a direction of future research. 
Instead, here we allow branch length (or rather $\tau$-coordinates) 
to be of two possible values: long (denoted by $\Lambda$) and short (denoted 
by $\lambda$). Node that the number of possible `branch lengths' can be 
generalised to any finite set $\lambda_1,\ldots,\lambda_s$\todo{It's worth 
pointing out explicitly what the change in what result will be.}.

More precisely, we consider a graph $\tN$ on the set of ranked rooted tree 
topologies (which we call simply trees from now on) with all leaves of rank 
$0$ and all intervals between nodes of the tree marked by $\Lambda$ or
$\lambda$. Two trees are adjacent in $\tN$ if and only if they are in 
adjacent orthants in $\tau$-space~\cite{Gavryushkin2014-bw} and the interval corresponding 
to the boundary in $\tau$-space is marked by $\lambda$ in both trees, 
or they are of the same ranked topology and there 
exists precisely one interval which is marked by different symbols in 
the two trees. 

The intuition behind this notion is that one move corresponds to either 
a $\tau$-move from a short interval to a new short interval or a change 
of the length of precisely one interval. 

First, we consider a uniform (lazy) random walk, where given a tree $T$ 
we do nothing with probability $p$, where $0\leq p\leq 1$ is the probability of 
\href{https://academichelp.net/wp-content/uploads/2014/01/laziness.jpg}{laziness},
and uniformly move to a neighbouring tree with probability $1-p$. 

\begin{lemma}
Let $T$ be a ranked tree on $n>2$ leaves. Then \[n-2\leq \deg(T)\leq3(n-2).\] 
\end{lemma}

\proof
Obvious.
\endproof

\begin{lemma}
\begin{enumerate}[(1)]
\item $deg(T)-deg(R) \leq 2(n-2).$
\item $\min\limits_{T,R}\dfrac{\deg(T)}{deg(R)} = \dfrac13$ for all $n.$
\end{enumerate}
\end{lemma}

\proof
Follows from previous Lemma. 
\endproof

These two lemmas remain unchanged if we increase the number of branch lengths. 

Other lemmas follow similarly too. 

Several important proposal mechanisms used in phylogenetic Bayesian inference by 
popular software packages such as BEAST2~\cite{beast2} favour topological moves
or tree moves depending on various conditions. All tree moves I have been 
considering so far do not make an explicit distinction between topological 
changes and branch length changes. To address this issue, we consider the
following tree move that explicitly allows distributing the acceptance 
probability between topological and branch length moves. 

{\bf Lazy walk.} Let $p$ be a laziness probability, that is, we do nothing 
with probability $p$ and distribute the rest of probability $1-p$ as follows. 
We decide first on what type of move we want to perform: choose a topological 
move with probability $q$ and a length move otherwise, that is, $q \leq 1-p$
and the probability of a length move is $1-p-q$. The proposal is rejected if
a topological move is impossible. 

{\bf tau move.} Choose a coordinate uniformly at random. Increase the
coordinate by $1$ with probability $p$ and decrease it by $1$ otherwise.
If the coordinate becomes $0$, resolve the multifurcation uniformly at
random and set the new coordinate to $1$. Note that this mechanism 
does not bound edge lengths from above favours topological moves when 
$p<1/2$. 

{\bf MH lazy walk.} Propose a tree in the one-neighbourhood uniformly at random. 
Accept the proposal with probability 
$\min(1, \dfrac{|N_1(T_{old})|}{|N_1(T_{new})|})$. 

\bibliography{curvatureNNI}
\bibliographystyle{alpha}

\end{document}
